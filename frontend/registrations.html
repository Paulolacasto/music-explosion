<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrations – THE MUSIC EXPLOSION</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
  body::before {
    content: "";
    background: url('images/logo-watermark.png') no-repeat center center;
    background-size: 1000px;
    opacity: 0.2;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }
</style>
</head>
<body class="bg-white text-gray-800">

<!-- Header -->
<header class="bg-blue-900 text-white">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <div class="flex items-center space-x-3">
      <img src="images/logo.png" alt="Logo" class="w-20 h-10">
      <div>
        <h1 class="text-2xl font-bold leading-tight">THE MUSIC EXPLOSION</h1>
        <p class="text-sm italic text-gray-200">…partake, perfect, perform</p>
      </div>
    </div>
    <nav class="space-x-4">
      <a href="index.html" class="hover:underline">Home</a>
      <a href="admin-dashboard.html" class="hover:underline">Admin Dashboard</a>
    </nav>
  </div>
</header>

<!-- Registrations Table -->
<section class="py-16 px-4 md:px-20">
  <h2 class="text-3xl font-bold text-center mb-10">Registered Participants</h2>

  <div class="mb-6 text-right space-x-4">
    <a href="http://localhost:5000/api/registrations/download" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800">
      Download as CSV
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="border px-4 py-2">#</th>
          <th class="border px-4 py-2">Name</th>
          <th class="border px-4 py-2">Email</th>
          <th class="border px-4 py-2">Phone</th>
          <th class="border px-4 py-2">Age</th>
          <th class="border px-4 py-2">Instruments</th>
          <th class="border px-4 py-2">Date</th>
          <th class="border px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody id="registrationTableBody">
        <!-- Populated with JS -->
      </tbody>
    </table>
  </div>
</section>

<!-- Footer -->
<footer class="bg-blue-900 text-white py-6 text-center">
  &copy; 2025 THE MUSIC EXPLOSION. All rights reserved.
</footer>

<script>
  function loadRegistrations() {
    fetch('http://localhost:5000/api/registrations')  // ✅ corrected endpoint
      .then(response => response.json())
      .then(data => {
        const tbody = document.getElementById('registrationTableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No registrations found.</td></tr>';
          return;
        }

        data.forEach((reg, index) => {
          const row = `
            <tr>
              <td class="border px-4 py-2">${index + 1}</td>
              <td class="border px-4 py-2">${reg.name}</td>
              <td class="border px-4 py-2">${reg.email}</td>
              <td class="border px-4 py-2">${reg.phone}</td>
              <td class="border px-4 py-2">${reg.age}</td>
              <td class="border px-4 py-2">${reg.instruments.join(', ')}</td>
              <td class="border px-4 py-2">${new Date(reg.registeredAt).toLocaleString()}</td>
              <td class="border px-4 py-2 space-x-2">
                <button onclick="editRegistration('${reg._id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Edit</button>
                <button onclick="deleteRegistration('${reg._id}')" class="bg-red-600 text-white px-2 py-1 rounded">Delete</button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('registrationTableBody').innerHTML =
          '<tr><td colspan="8" class="text-center py-4 text-red-600">Error loading registrations.</td></tr>';
      });
  }

  async function deleteRegistration(id) {
    if (!confirm('Are you sure you want to delete this registration?')) return;

    const res = await fetch(`http://localhost:5000/api/registrations/${id}`, { method: 'DELETE' });  // ✅ corrected
    const data = await res.json();

    if (res.ok) {
      alert('Deleted successfully!');
      loadRegistrations();
    } else {
      alert(data.error || 'Error deleting');
    }
  }

  async function editRegistration(id) {
    const newName = prompt('Enter new name:');
    if (!newName) return;

    const res = await fetch(`http://localhost:5000/api/registrations/${id}`, {  // ✅ corrected
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: newName })
    });

    const data = await res.json();

    if (res.ok) {
      alert('Updated successfully!');
      loadRegistrations();
    } else {
      alert(data.error || 'Error updating');
    }
  }

  loadRegistrations();
</script>

</body>
</html>
